# NNF Container Profile Management
#
# When you get ready to pull your (most interesting) container image from your
# own container registry, you will need to update, and re-deploy you NNF
# container profile
#
# When you are ready to do this, change the two lines below that contain:
# `image: docker.io/mcfadden8/axl:latest` to point to your image.
#
# NOTE: feel free to ask me if you need to have your nnf container profile updated
# and redeployed.  I'm happy to help! There do be some dragons
#
# To see the nnf container profiles already deployed, run:
#    kubectl get nnfcontainerprofiles -A
#
# To remove your deployed nnf container profile so you can deploy a new one, run:
#    kubectl delete nnfcontainerprofiles -n nnf-system axl-container-$( whoami )
#
# To deploy a new nnf container profile run:
#    kubectl apply -f axl-container-$( whoami ).yaml
---
apiVersion: nnf.cray.hpe.com/v1alpha1
kind: NnfContainerProfile
metadata:
  name: axl-container-haridev
  namespace: nnf-system
data:
  storages:
    - name: DW_JOB_storage
      optional: false
    - name: DW_PERSISTENT_storage
      optional: true
  mpiSpec:
    mpiReplicaSpecs:
      Launcher:
        template:
          spec:
            containers:
              - name: axl-container-haridev
                image: docker.io/mcfadden8/axl:latest
                command: ["/bin/bash"]
                args: ["-c", "mpirun mpi_hello_world $(DW_JOB_storage) /p/lslide/haridev"]
                volumeMounts:
                  - mountPath: /p/lslide
                    name: lslide
            volumes:
              - name: lslide
                persistentVolumeClaim:
                  claimName: kern-default-readwritemany-pvc
      Worker:
        template:
          spec:
            containers:
              - name: axl-container-haridev
                securityContext:
                  allowPrivilegeEscalation: true
                  capabilities:
                    add:
                    - NET_BIND_SERVICE
                    - SYS_CHROOT
                    - AUDIT_WRITE
                image: docker.io/mcfadden8/axl:latest

